myApp.controller('userController', ['$scope', 'userService', function($scope, userService){
    $scope.users = [];

    $scope.messageLogin = "";
    var url = window.location.href;
    if(url.indexOf("invalidLogin") != -1){
        $scope.messageLogin = "Invalid Login, Please try again !";
    }

    if(url.indexOf("myLogout") != -1){
        $scope.messageLogin = "You have already logout Website !";
    }

    $scope.infoUserLogin = "";
    var getUserLogin = function (url) {
        userService.fetchGet(url)
            .then(
                function(res){
                    $scope.infoUserLogin = res;
                    // alert("User" + $scope.infoUserLogin.username + $scope.infoUserLogin.authorities);
                },
                function(err){
                    alert(err);
                }
            )
    }

    getUserLogin("/user/getUserLogin");

    var listUserAll = function(url){
        userService.fetchGet(url)
            .then(
                function(res){
                    $scope.users = res;
                },
                function(err){
                    alert(err);
                }
            )
    }

    listUserAll("/user/list");

    $scope.search = function(){
        if($scope.user.code === undefined && $scope.user.fullname === undefined && $scope.user.email === undefined){
            listUserAll("/user/listAllUser");
        }else{
            userService.fetchPost("/user/likeListUser", $scope.user)
                .then(
                    function(res){
                        $scope.users = res.data;
                    },
                    function(err){
                        alert(err);
                    }
                )

        }

    }

    $scope.deleteContentUser = function(){
        $scope.user = {};
        listUserAll("/user/listAllUser");
    }

    $scope.save = function(){

        userService.fetchPost("/user/saveUser", {
            code : $scope.userUpdate.codeUpdate,
            username : $scope.userUpdate.usernameUpdate,
            password : $scope.userUpdate.passwordUpdate,
            email : $scope.userUpdate.emailUpdate,
            fullname : $scope.userUpdate.fullnameUpdate,
            position : $scope.userUpdate.positionUpdate
        })
            .then(
                function(res){
                    if(res.data.content == "200"){
                        $scope.users.push({
                            id : $scope.userUpdate.idUpdate,
                            code : $scope.userUpdate.codeUpdate,
                            username : $scope.userUpdate.usernameUpdate,
                            email : $scope.userUpdate.emailUpdate,
                            fullname : $scope.userUpdate.fullnameUpdate,
                            position : $scope.userUpdate.positionUpdate
                        });
                    }else{
                        alert(res.data.content);
                    }
                },
                function(err){
                    alert(err);
                }
            )


    }

    $scope.update = function(object, index){
        $scope.styles = {
            "position": "fixed",
            "z-index": "1",
            "padding-top": "100px",
            "left": "0",
            "top": "0",
            "width": "100%",
            "height": "100%",
            "overflow": "auto",
            "background-color": "rgb(0,0,0)",
            "background-color": "rgba(0,0,0,0.4)"
        };
        indexUpdate = index;
        $scope.userUpdateBase = {
            idUpdateBase : object.id,
            codeUpdateBase : object.code,
            usernameUpdateBase : object.username,
            emailUpdateBase : object.email,
            fullnameUpdateBase : object.fullname,
            positionUpdateBase : object.position
        }
        $scope.userUpdate = {
            idUpdate : object.id,
            codeUpdate : object.code,
            usernameUpdate : object.username,
            emailUpdate : object.email,
            fullnameUpdate : object.fullname,
            positionUpdate : object.position
        }
    }
    $scope.updates = function(){
        var count = 0;
        if($scope.userUpdateBase.codeUpdateBase == $scope.userUpdate.codeUpdate && $scope.userUpdate.codeUpdate !== undefined){
            $scope.userUpdateBase.codeUpdateBase = "";
            count++;
        }else{
            $scope.userUpdateBase.codeUpdateBase = $scope.userUpdate.codeUpdate;
        }
        if($scope.userUpdateBase.usernameUpdateBase == $scope.userUpdate.usernameUpdate && $scope.userUpdate.usernameUpdate !== undefined){
            $scope.userUpdateBase.usernameUpdateBase = "";
            count++;
        }else{
            $scope.userUpdateBase.usernameUpdateBase = $scope.userUpdate.usernameUpdate;
        }
        if($scope.userUpdateBase.emailUpdateBase == $scope.userUpdate.emailUpdate && $scope.userUpdate.emailUpdate !== undefined){
            $scope.userUpdateBase.emailUpdateBase = "";
            count++;
        }else{
            $scope.userUpdateBase.emailUpdateBase = $scope.userUpdate.emailUpdate;
        }
        if($scope.userUpdateBase.fullnameUpdateBase == $scope.userUpdate.fullnameUpdate && $scope.userUpdate.fullnameUpdate !== undefined){
            $scope.userUpdateBase.fullnameUpdateBase = "";
            count++;
        }else{
            $scope.userUpdateBase.fullnameUpdateBase = $scope.userUpdate.fullnameUpdate;
        }
        if($scope.userUpdateBase.positionUpdateBase == $scope.userUpdate.positionUpdate && $scope.userUpdate.positionUpdate !== undefined){
            $scope.userUpdateBase.positionUpdateBase = "";
            count++;
        }else{
            $scope.userUpdateBase.positionUpdateBase = $scope.userUpdate.positionUpdate;
        }
        if(count == 5){
            alert("Hãy thay đổi thông tin bạn muốn cập nhật");
            $scope.userUpdateBase = {
                idUpdateBase : $scope.userUpdate.idUpdate,
                codeUpdateBase : $scope.userUpdate.codeUpdate,
                usernameUpdateBase : $scope.userUpdate.usernameUpdate,
                emailUpdateBase : $scope.userUpdate.emailUpdate,
                fullnameUpdateBase : $scope.userUpdate.fullnameUpdate,
                positionUpdateBase : $scope.userUpdate.positionUpdate
            }
        }else{
            userService.fetchPost("/user/updateUser", {
                id : $scope.userUpdateBase.idUpdateBase,
                code : $scope.userUpdateBase.codeUpdateBase,
                username : $scope.userUpdateBase.usernameUpdateBase,
                email : $scope.userUpdateBase.emailUpdateBase,
                password : $scope.userUpdate.passwordUpdate,
                fullname : $scope.userUpdateBase.fullnameUpdateBase,
                position : $scope.userUpdateBase.positionUpdateBase
            })
                .then(
                    function(res){
                        if(res.data.content == "200"){
                            $scope.users[indexUpdate] = {
                                id : $scope.userUpdate.idUpdate,
                                code : $scope.userUpdate.codeUpdate,
                                username : $scope.userUpdate.usernameUpdate,
                                email : $scope.userUpdate.emailUpdate,
                                fullname : $scope.userUpdate.fullnameUpdate,
                                position : $scope.userUpdate.positionUpdate
                            };
                        }else{
                            alert(res.data.content);
                        }

                    },
                    function(err){
                        alert(err);
                    }
                )

        }
    }

    $scope.delete = function(index, id){
        userService.fetchDelete("/user/delete/", id)
            .then(
                function(res){
                    $scope.users.splice(index, 1);
                },
                function(err){
                    alert(err);
                }
            )
    }

    $scope.roleForUser = function(id){
        window.location = "http://localhost:8080/user/RoleForUser/".concat(id);
    }
}])